{%- set title = _("Top 5 Works Cited") %}
{%- extends config.kerko.templates.page %}

{%- block head %}{{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{%- endblock %}

{%- block content_inner %}
    <div class="dashboard">
        <!-- Bootstrap Carousel -->
        <div id="carousel" class="carousel slide" data-bs-ride="carousel">
            <!-- Carousel Indicators -->
            <div class="carousel-indicators">
                {% for dataset in all_data %}
                <button type="button" data-bs-target="#carousel" data-bs-slide-to="{{ loop.index0 }}" class="{% if loop.first %}active{% endif %}"></button>
                {% endfor %}
            </div>

            <!-- Carousel Inner -->
            <div class="carousel-inner">
                {% for dataset in all_data %}
                {% set ns = namespace(title=None, date=None, doi=None, url=None, other_info=[]) %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                    <div class="carousel-content">
            {# Loop over each dict in dataset to extract values #}
            {% for item in dataset %}
                {% for key, value in item.items() %}
                    {% if key == 'title' %}
                        {% set ns.title = value %}
                    {% elif key == 'date' %}
                        {% set ns.date = value %}
                    {% elif key == 'DOI' %}
                        {% set ns.doi = value %}
                    {% elif key == 'url' %}
                        {% set ns.url = value %}
                    {% else %}
                        {% set _ = ns.other_info.append((key, value)) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {# Title #}
            {% if ns.title %}
                <div class="card-title">{{ ns.title }}</div>
            {% endif %}

            {# Middle content: extra fields #}
            {% for key, value in ns.other_info %}
                {% if key == 'extra' and value is mapping %}
                    <div class="info-block">
                        {% if value.CitedBy is defined %}
                            <strong>Cited By:</strong> {{ value.CitedBy }}{% if value.Cites is defined %}{% endif %}
                        {% endif %}
                        {% if value.Cites is defined %}
                            <strong>Cites:</strong> {{ value.Cites }}
                        {% endif %}
                    </div>
                {% elif key not in ['OpenAlex', 'OpenAccess', 'OALink', 'extra'] %}
                    <div class="info-block">
                        <strong>{{ key }}:</strong>
                        {% if value is mapping %}
                            {% for subkey, subvalue in value.items() %}
                                {{ subvalue }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        {% elif value is iterable and value is not string %}
                            {% for subval in value %}
                                {% if subval is mapping %}
                                    {% for subkey, subvalue in subval.items() %}
                                        {{ subvalue }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    {{ subval }}{% if not loop.last %}, {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% if value is string and ('http://' in value or 'https://' in value) %}
                                <a href="{{ value }}" target="_blank">{{ value }}</a>
                            {% else %}
                                {{ value }}
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            {# Footer with date and DOI #}
            <div class="card-footer">
                {% if ns.date %}<div><strong>Date:</strong> {{ ns.date }}</div>{% endif %}
                {% if ns.doi %}
                    <div>
                        <strong>DOI:</strong>
                        <a href="https://doi.org/{{ ns.doi }}" target="_blank">{{ ns.doi }}</a>
                    </div>
                {% endif %}
                {% if ns.url %}
                    <div>
                        <strong>URL:</strong>
                        <a href="{{ ns.url }}" target="_blank">{{ ns.url }}</a>
                    </div>
                {% endif %}
            </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            </div>
            <!-- Carousel Controls -->
            <div class="carousel-controls">
                <button class="carousel-btn" type="button" data-bs-target="#carousel" data-bs-slide="prev">
                    {{ _("Previous") }}
                </button>
                <button class="carousel-btn" type="button" data-bs-target="#carousel" data-bs-slide="next">
                    {{ _("Next") }}
                </button>
            </div>
        </div>
        <!-- Citation Chart -->
        <div class="chart-container">
            <h2>Publication References Over 13 Years</h2>
            <canvas id="myChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Publication Types</h2>
            <canvas id="pieChart"></canvas>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const carousel = document.getElementById('carousel');
            const carouselInstance = new bootstrap.Carousel(carousel, {
                interval: 10000, // 10 seconds between slides
                wrap: true,
                pause: 'hover'
            });

            // Initialize the chart
            var data = {{ chartJSON | safe }};
            var ctx = document.getElementById('myChart').getContext('2d');
            var myChart = new Chart(ctx, data);
        });
    </script>
    <script>
        const pieChartJSON = {{ pieChartJSON|safe }};
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        new Chart(pieCtx, pieChartJSON);
    </script>
    </script>
{%- endblock content_inner %}